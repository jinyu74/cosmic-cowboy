import Phaser from 'phaser'

const FONT_KEY = 'hud-pixel-font'
const CHAR_WIDTH = 6
const CHAR_HEIGHT = 8
const CHARSET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789:/-. '

const FONT_MAP: Record<string, string[]> = {
  A: ['01110', '10001', '10001', '11111', '10001', '10001', '10001'],
  B: ['11110', '10001', '10001', '11110', '10001', '10001', '11110'],
  C: ['01110', '10001', '10000', '10000', '10000', '10001', '01110'],
  D: ['11110', '10001', '10001', '10001', '10001', '10001', '11110'],
  E: ['11111', '10000', '10000', '11110', '10000', '10000', '11111'],
  F: ['11111', '10000', '10000', '11110', '10000', '10000', '10000'],
  G: ['01110', '10001', '10000', '10111', '10001', '10001', '01110'],
  H: ['10001', '10001', '10001', '11111', '10001', '10001', '10001'],
  I: ['01110', '00100', '00100', '00100', '00100', '00100', '01110'],
  J: ['00111', '00010', '00010', '00010', '10010', '10010', '01100'],
  K: ['10001', '10010', '10100', '11000', '10100', '10010', '10001'],
  L: ['10000', '10000', '10000', '10000', '10000', '10000', '11111'],
  M: ['10001', '11011', '10101', '10001', '10001', '10001', '10001'],
  N: ['10001', '11001', '10101', '10011', '10001', '10001', '10001'],
  O: ['01110', '10001', '10001', '10001', '10001', '10001', '01110'],
  P: ['11110', '10001', '10001', '11110', '10000', '10000', '10000'],
  Q: ['01110', '10001', '10001', '10001', '10101', '10010', '01101'],
  R: ['11110', '10001', '10001', '11110', '10100', '10010', '10001'],
  S: ['01111', '10000', '10000', '01110', '00001', '00001', '11110'],
  T: ['11111', '00100', '00100', '00100', '00100', '00100', '00100'],
  U: ['10001', '10001', '10001', '10001', '10001', '10001', '01110'],
  V: ['10001', '10001', '10001', '10001', '10001', '01010', '00100'],
  W: ['10001', '10001', '10001', '10001', '10101', '11011', '10001'],
  X: ['10001', '10001', '01010', '00100', '01010', '10001', '10001'],
  Y: ['10001', '10001', '01010', '00100', '00100', '00100', '00100'],
  Z: ['11111', '00001', '00010', '00100', '01000', '10000', '11111'],
  '0': ['01110', '10001', '10011', '10101', '11001', '10001', '01110'],
  '1': ['00100', '01100', '00100', '00100', '00100', '00100', '01110'],
  '2': ['01110', '10001', '00001', '00010', '00100', '01000', '11111'],
  '3': ['11110', '00001', '00001', '01110', '00001', '00001', '11110'],
  '4': ['00010', '00110', '01010', '10010', '11111', '00010', '00010'],
  '5': ['11111', '10000', '10000', '11110', '00001', '00001', '11110'],
  '6': ['01110', '10000', '10000', '11110', '10001', '10001', '01110'],
  '7': ['11111', '00001', '00010', '00100', '01000', '01000', '01000'],
  '8': ['01110', '10001', '10001', '01110', '10001', '10001', '01110'],
  '9': ['01110', '10001', '10001', '01111', '00001', '00001', '01110'],
  ':': ['00000', '00100', '00100', '00000', '00100', '00100', '00000'],
  '/': ['00001', '00010', '00100', '01000', '10000', '00000', '00000'],
  '-': ['00000', '00000', '00000', '01110', '00000', '00000', '00000'],
  '.': ['00000', '00000', '00000', '00000', '00000', '00100', '00100'],
  ' ': ['00000', '00000', '00000', '00000', '00000', '00000', '00000'],
}

export function ensurePixelFont(scene: Phaser.Scene): string {
  if (scene.cache.bitmapFont.has(FONT_KEY)) {
    return FONT_KEY
  }

  if (!scene.textures.exists(FONT_KEY)) {
    const width = CHAR_WIDTH * CHARSET.length
    const height = CHAR_HEIGHT
    const texture = scene.textures.createCanvas(FONT_KEY, width, height)
    if (!texture) {
      return FONT_KEY
    }

    const ctx = texture.getContext()
    ctx.clearRect(0, 0, width, height)
    ctx.fillStyle = '#ffffff'

    for (let i = 0; i < CHARSET.length; i += 1) {
      const char = CHARSET[i]
      const glyph = FONT_MAP[char] ?? FONT_MAP[' ']
      const baseX = i * CHAR_WIDTH

      for (let y = 0; y < glyph.length; y += 1) {
        const row = glyph[y]
        for (let x = 0; x < row.length; x += 1) {
          if (row[x] === '1') {
            ctx.fillRect(baseX + x, y, 1, 1)
          }
        }
      }
    }

    texture.refresh()
  }

  const fontData = Phaser.GameObjects.RetroFont.Parse(scene, {
    image: FONT_KEY,
    width: CHAR_WIDTH,
    height: CHAR_HEIGHT,
    chars: CHARSET,
    charsPerRow: CHARSET.length,
    'offset.x': 0,
    'offset.y': 0,
    'spacing.x': 0,
    'spacing.y': 0,
    lineSpacing: 0,
  })

  if (fontData) {
    scene.cache.bitmapFont.add(FONT_KEY, fontData)
  }

  return FONT_KEY
}
